<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Page</title>

  <link rel="stylesheet" href="../offline/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    body {
        padding: 0 !important;
        margin: 0 !important;
        font-family: 'Poppins', sans-serif;
        background: #f8f9fa;
    }

    .account-wrapper {
        min-height: 100vh;
        background: #f8f9fa;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
    }

    .account-header {
        background: linear-gradient(135deg, #5BC2E7 0%, #4facfe 100%);
        padding: 60px 20px 40px;
        color: white;
        position: relative;
        text-align: center;
    }

    .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .back-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }

    .back-button i {
        color: white;
        font-size: 20px;
    }

    .profile-section {
        text-align: center;
        padding: 20px 0;
    }

    .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 4px solid white;
        margin: 0 auto 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        object-fit: cover;
    }

    .profile-name {
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 5px 0;
        text-transform: uppercase;
    }

    .profile-email {
        font-size: 14px;
        opacity: 0.9;
        margin: 0;
    }

    .menu-section {
        background: white;
        margin: 20px 20px 20px;
        border-radius: 20px;
        padding: 20px 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .menu-item {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        text-decoration: none;
        color: #333;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }

    .menu-item:last-child {
        border-bottom: none;
    }

    .menu-item:hover {
        background: #f8f9fa;
    }

    .menu-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: #f0f7ff;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .menu-icon i {
        font-size: 20px;
        color: #5BC2E7;
    }

    .menu-content {
        flex: 1;
    }

    .menu-title {
        font-size: 15px;
        font-weight: 600;
        margin: 0 0 2px 0;
        color: #333;
    }

    .menu-subtitle {
        font-size: 12px;
        color: #999;
        margin: 0;
    }

    .menu-arrow {
        color: #ccc;
        font-size: 18px;
    }

    .stats-section {
        padding: 20px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 20px !important;
    }

    .stat-card {
        flex: 1;
        background: white;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #5BC2E7;
        margin: 0 0 5px 0;
    }

    .stat-label {
        font-size: 13px;
        color: #999;
        margin: 0;
    }

    .logout-section {
        padding: 20px;
        margin-top: auto;
        background: #f8f9fa;
    }

    .logout-button {
        width: 100%;
        padding: 16px;
        background: white;
        border: 2px solid #fee2e2;
        border-radius: 12px;
        color: #dc2626;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .logout-button:hover {
        background: #fee2e2;
    }

    .logout-button i {
        font-size: 20px;
    }

    @media (max-width: 768px) {
        .account-header {
            padding: 50px 15px 30px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
        }

        .profile-name {
            font-size: 20px;
        }

        .menu-section {
            margin: 15px 15px 15px;
        }

        .logout-section {
            padding: 20px 15px;
        }
    }
  </style>
</head>

<body>
  <div class="network-status" id="networkStatus" onclick="toggleNetworkMode()">
      <span class="network-status-dot"></span>
      <span id="networkStatusText">Checking...</span>
  </div>

  <div class="account-wrapper">
    <div class="account-header">
      <button class="back-button" onclick="window.location.href='home.html'">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div class="profile-section">
        <img src="../images/aaa.png"
              onerror="this.src='images/aaa.png';"
              alt="Avatar Image"
              class="profile-avatar">
        <h2 class="profile-name"></h2>
        <p class="profile-email">maria.catalina.rances@gmail.com</p>
      </div>
    </div>

    <div class="menu-section">
      <a href="#" class="menu-item">
        <div class="menu-icon"><i class="bi bi-person"></i></div>
        <div class="menu-content">
          <h4 class="menu-title">Account Settings</h4>
          <p class="menu-subtitle">View and edit your profile</p>
        </div>
        <i class="bi bi-chevron-right menu-arrow"></i>
      </a>

      <a href="#" class="menu-item">
        <div class="menu-icon"><i class="bi bi-clock-history"></i></div>
        <div class="menu-content">
          <h4 class="menu-title">Subscription History</h4>
          <p class="menu-subtitle">View your redemption history</p>
        </div>
        <i class="bi bi-chevron-right menu-arrow"></i>
      </a>

      <a href="#" class="menu-item">
        <div class="menu-icon"><i class="bi bi-receipt"></i></div>
        <div class="menu-content">
          <h4 class="menu-title">Business Information</h4>
          <p class="menu-subtitle">View all your transactions</p>
        </div>
        <i class="bi bi-chevron-right menu-arrow"></i>
      </a>

      <a href="#" class="menu-item">
        <div class="menu-icon"><i class="bi bi-info-circle"></i></div>
        <div class="menu-content">
          <h4 class="menu-title">Help & Support</h4>
          <p class="menu-subtitle">Get help and contact support</p>
        </div>
        <i class="bi bi-chevron-right menu-arrow"></i>
      </a>
    </div>

    <div class="logout-section">
      <button class="logout-button" onclick="logoutOfflineUser()">
        <i class="bi bi-box-arrow-right"></i>
        Log Out
      </button>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/offline/offline.js"></script>
    <script src="network_status.js"></script>
    <script src="../offline/network_status.js"></script>

    <script>
    // Get current user information
    async function loadCurrentUserInfo() {
        try {
            // Get user data from localStorage
            const offlineUser = localStorage.getItem('offlineUser');
            const currentUserId = localStorage.getItem('current_user_id');
            const currentUserName = localStorage.getItem('current_user_name');
            const currentUserEmail = localStorage.getItem('current_user_email');
            const currentUserRole = localStorage.getItem('current_user_role');

            let userData = null;

            // Try to parse offlineUser first
            if (offlineUser) {
                try {
                    userData = JSON.parse(offlineUser);
                    console.log('✅ User data loaded from offlineUser:', userData);
                } catch (e) {
                    console.warn('⚠️ Failed to parse offlineUser');
                }
            }

            // If no userData from offlineUser, try individual localStorage items
            if (!userData && currentUserId) {
                userData = {
                    id: currentUserId,
                    name: currentUserName || 'User',
                    email: currentUserEmail || '',
                    role: currentUserRole || '',
                    phone: localStorage.getItem('current_user_phone') || '',
                    address: localStorage.getItem('current_user_address') || ''
                };
                console.log('✅ User data loaded from individual localStorage items:', userData);
            }

            // If still no userData, try to fetch from IndexedDB
            if (!userData && currentUserId) {
                userData = await fetchUserFromDB(currentUserId);
                console.log('✅ User data loaded from IndexedDB:', userData);
            }

            // Display user information
            if (userData) {
                displayUserInfo(userData);
            } else {
                console.error('❌ No user data found');
                // Redirect to login if no user data
                Swal.fire({
                    icon: 'warning',
                    title: 'Session Expired',
                    text: 'Please log in again.',
                    confirmButtonColor: '#5BC2E7'
                }).then(() => {
                    window.location.href = 'login.html';
                });
            }

        } catch (error) {
            console.error('❌ Error loading user info:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load user information.',
                confirmButtonColor: '#5BC2E7'
            });
        }
    }

    // Fetch user from IndexedDB
    async function fetchUserFromDB(userId) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('CRMSDB', 3);

            request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                const getRequest = store.get(parseInt(userId));

                getRequest.onsuccess = () => {
                    resolve(getRequest.result);
                };

                getRequest.onerror = () => {
                    reject(getRequest.error);
                };
            };

            request.onerror = () => {
                reject(request.error);
            };
        });
    }

    // Display user information in the page
    function displayUserInfo(userData) {
        // Display name
        const profileNameElement = document.querySelector('.profile-name');
        if (profileNameElement && userData.name) {
            profileNameElement.textContent = userData.name.toUpperCase();
        }

        // Display email
        const profileEmailElement = document.querySelector('.profile-email');
        if (profileEmailElement) {
            if (userData.email) {
                profileEmailElement.textContent = userData.email;
            } else if (userData.phone) {
                profileEmailElement.textContent = userData.phone;
            } else {
                profileEmailElement.textContent = 'No email available';
            }
        }

        // Optional: Add role badge or additional info
        if (userData.role) {
            const roleInfo = document.createElement('p');
            roleInfo.style.cssText = `
                background: rgba(255, 255, 255, 0.3);
                display: inline-block;
                padding: 6px 16px;
                border-radius: 20px;
                font-size: 12px;
                margin-top: 8px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
            `;
            roleInfo.textContent = userData.role;
            
            const profileSection = document.querySelector('.profile-section');
            if (profileSection) {
                profileSection.appendChild(roleInfo);
            }
        }

        console.log('✅ User info displayed successfully');
    }

    // Logout function
    function logoutOfflineUser() {
        Swal.fire({
            title: 'Log Out?',
            text: 'Are you sure you want to log out?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Log Out',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#6c757d'
        }).then((result) => {
            if (result.isConfirmed) {
                // Clear all user data from localStorage
                localStorage.removeItem('offlineUser');
                localStorage.removeItem('current_user_id');
                localStorage.removeItem('current_user_name');
                localStorage.removeItem('current_user_email');
                localStorage.removeItem('current_user_role');
                localStorage.removeItem('current_user_phone');
                localStorage.removeItem('current_user_address');
                
                // Clear cart data
                localStorage.removeItem('dealerCartData');
                localStorage.removeItem('dealerCartItems');
                localStorage.removeItem('dealerOrderData');
                localStorage.removeItem('selectedCustomerId');
                localStorage.removeItem('selectedCustomerName');
                localStorage.removeItem('selectedCustomerSerial');
                localStorage.removeItem('selectedCustomerNumber');

                Swal.fire({
                    icon: 'success',
                    title: 'Logged Out',
                    text: 'You have been successfully logged out.',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = 'login.html';
                });
            }
        });
    }

    // Load user info when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadCurrentUserInfo();
    });
    </script>
</body>
</html>
