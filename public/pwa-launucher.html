<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#5DADE2">
    <title>Loading GazLite...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #5DADE2 0%, #4facfe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .loader-container {
            text-align: center;
            color: white;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .logo-text {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .status-text {
            font-size: 16px;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            margin: 0 auto;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .debug-info {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            font-family: monospace;
            max-width: 90%;
            text-align: center;
            display: none;
        }

        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="loader-container">
        <div class="logo">
            <div class="logo-text">ðŸ’¨</div>
        </div>
        <h1 style="font-size: 32px; margin-bottom: 10px;">GazLite</h1>
        <p class="status-text" id="statusText">Initializing...</p>
        <div class="spinner"></div>
    </div>

    <div class="debug-info" id="debugInfo"></div>

    <script>
        // Enable debug mode (set to false in production)
        const DEBUG = true;

        function log(message) {
            console.log(`[PWA Launcher] ${message}`);
            if (DEBUG) {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.textContent = message;
                debugInfo.classList.add('show');
            }
        }

        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        async function checkConnection() {
            log('Checking network connection...');
            updateStatus('Checking connection...');

            // First check: navigator.onLine
            if (!navigator.onLine) {
                log('navigator.onLine = false');
                return false;
            }

            // Second check: Try to fetch a reliable endpoint
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch('https://www.google.com/generate_204', {
                    method: 'HEAD',
                    cache: 'no-store',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                log(`Connection test: ${response.ok ? 'ONLINE' : 'OFFLINE'}`);
                return response.ok;
            } catch (error) {
                log(`Connection test failed: ${error.message}`);
                return false;
            }
        }

        function getBasePath() {
            const path = window.location.pathname;
            if (path.includes('/crms/public')) {
                return '/crms/public';
            }
            return '';
        }

        function checkAuthentication() {
            log('Checking authentication...');
            
            const offlineUser = localStorage.getItem('offlineUser');
            const currentUserId = localStorage.getItem('current_user_id');
            
            log(`offlineUser: ${offlineUser ? 'EXISTS' : 'MISSING'}`);
            log(`current_user_id: ${currentUserId || 'MISSING'}`);
            
            if (offlineUser) {
                try {
                    const userData = JSON.parse(offlineUser);
                    
                    // Check session expiry
                    if (userData.loginTime) {
                        const sessionAge = Date.now() - new Date(userData.loginTime).getTime();
                        const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                        
                        if (sessionAge > maxAge) {
                            log('Session expired');
                            // Clear expired session
                            localStorage.removeItem('offlineUser');
                            localStorage.removeItem('current_user_id');
                            localStorage.removeItem('current_user_role');
                            return { authenticated: false };
                        }
                    }
                    
                    log(`Authenticated as: ${userData.name}`);
                    return { authenticated: true, user: userData };
                } catch (e) {
                    log(`Error parsing offlineUser: ${e.message}`);
                    localStorage.removeItem('offlineUser');
                }
            }
            
            if (currentUserId) {
                log('Authenticated via current_user_id');
                return { authenticated: true };
            }
            
            log('Not authenticated');
            return { authenticated: false };
        }

        async function redirect() {
            const BASE_PATH = getBasePath();
            log(`Base path: ${BASE_PATH}`);
            
            const isOnline = await checkConnection();
            const auth = checkAuthentication();
            
            log(`Online: ${isOnline}, Authenticated: ${auth.authenticated}`);
            
            let targetUrl;
            
            if (isOnline) {
                // ONLINE - Go to Laravel routes
                updateStatus('Loading online version...');
                log('Redirecting to ONLINE version');
                
                if (auth.authenticated) {
                    targetUrl = `${BASE_PATH}/home`;
                } else {
                    targetUrl = `${BASE_PATH}/login`;
                }
            } else {
                // OFFLINE - Go to static HTML pages
                updateStatus('Loading offline version...');
                log('Redirecting to OFFLINE version');
                
                if (auth.authenticated) {
                    targetUrl = `${BASE_PATH}/offline/home.html`;
                } else {
                    targetUrl = `${BASE_PATH}/offline/login.html`;
                }
            }
            
            log(`Final target: ${targetUrl}`);
            
            // Small delay for smooth transition
            setTimeout(() => {
                window.location.replace(targetUrl);
            }, 500);
        }

        // Start the launcher
        window.addEventListener('load', () => {
            log('PWA Launcher started');
            redirect();
        });

        // Handle cases where window.load doesn't fire
        if (document.readyState === 'complete') {
            log('Document already loaded');
            redirect();
        }
    </script>
</body>
</html>